{"version":3,"file":"history-plugin.esm.js","sources":["../src/action.js","../src/actions/connection.js","../src/actions/node.js","../src/history.js","../src/index.js"],"sourcesContent":["export default class Action {\n    undo() {}\n\n    redo() {}\n}\n","import Action from '../action';\n\n// The saved connection may have been removed and recreated, so make sure we are working with the correct reference\nfunction findNewConnection(oldConnection) {\n    const { input, output } = oldConnection;\n\n    return output.connections.find(c => c.input === input);\n}\n\nclass ConnectionActionHelper {\n    constructor(editor, connection) {\n        this.editor = editor;\n        this.connection = connection;\n    }\n\n    add() {\n        this.editor.connect(this.connection.output, this.connection.input);\n    }\n\n    remove() {\n        this.editor.removeConnection(findNewConnection(this.connection));\n    }\n}\n\nexport class AddConnectionAction extends Action {\n    constructor(editor, connection) {\n        super();\n        this.helper = new ConnectionActionHelper(editor, connection);\n    }\n\n    undo() { this.helper.remove(); }\n\n    redo() { this.helper.add(); }\n}\n\nexport class RemoveConnectionAction extends Action {\n    constructor(editor, connection) {\n        super();\n        this.helper = new ConnectionActionHelper(editor, connection);\n    }\n\n    undo() { this.helper.add(); }\n\n    redo() { this.helper.remove(); }\n}\n","import Action from '../action';\n\nclass NodeAction extends Action {\n    constructor(editor, node) {\n        super();\n        this.editor = editor;\n        this.node = node;\n    }\n}\n\nexport class AddNodeAction extends NodeAction {\n    undo() {\n        this.editor.removeNode(this.node);\n    }\n\n    redo() {\n        this.editor.addNode(this.node);\n    }\n}\n\nexport class RemoveNodeAction extends NodeAction {\n    undo() {\n        this.editor.addNode(this.node);\n    }\n\n    redo() {\n        this.editor.removeNode(this.node);\n    }\n}\n\nexport class DragNodeAction extends NodeAction {\n    constructor(editor, node, prev) {\n        super(editor, node);\n\n        this.prev = [...prev];\n        this.new = [...node.position];\n    }\n\n    _translate(position) {\n        this.editor.view.nodes.get(this.node).translate(...position);\n    }\n    \n    undo() {\n        this._translate(this.prev);\n    }\n\n    redo() {\n        this._translate(this.new);\n    }\n\n    update(node) {\n        this.new = [...node.position];\n    }\n}\n","export default class History {\n    constructor() {\n        this.active = false;\n        this.produced = [];\n        this.reserved = [];\n    }\n\n    add(action) {\n        if (this.active) return;\n        this.produced.push(action);\n        this.reserved = [];\n    }\n\n    get last() {\n        return this.produced[this.produced.length - 1];\n    }\n\n    _do(from, to, type) {\n        const action = from.pop();\n\n        if (!action) return;\n\n        this.active = true;\n        action[type]();\n        to.push(action);\n        this.active = false;\n    }\n\n    undo() {\n        this._do(this.produced, this.reserved, 'undo');\n    }\n\n    clear() {\n        this.active = false;\n        this.produced = [];\n        this.reserved = [];\n    }\n\n    redo() {\n        this._do(this.reserved, this.produced, 'redo');\n    }\n}\n","import { AddConnectionAction, RemoveConnectionAction } from './actions/connection';\nimport { AddNodeAction, DragNodeAction, RemoveNodeAction } from './actions/node';\nimport Act from './action';\nimport History from './history';\n\nfunction trackNodes(editor, history) {\n    editor.on('nodecreated', node => history.add(new AddNodeAction(editor, node)));\n    editor.on('noderemoved', node => history.add(new RemoveNodeAction(editor, node)));\n    editor.on('nodetranslated', ({ node, prev }) => {\n        if (history.last instanceof DragNodeAction && history.last.node === node)\n            history.last.update(node);\n        else\n            history.add(new DragNodeAction(editor, node, prev));\n    });\n}\n\nfunction trackConnections(editor, history) {\n    editor.on('connectioncreated', c => history.add(new AddConnectionAction(editor, c)));\n    editor.on('connectionremoved', c => history.add(new RemoveConnectionAction(editor, c)));\n}\n\n// eslint-disable-next-line max-statements\nfunction install(editor, { keyboard = true }) {\n    editor.bind('undo');\n    editor.bind('redo');\n    editor.bind('addhistory');\n\n    const history = new History();\n\n    editor.on('undo', () => history.undo());\n    editor.on('redo', () => history.redo());\n    editor.on('addhistory', action => history.add(action));\n    editor.on('clear', () => {\n        history.clear();\n    });\n    if (keyboard) document.addEventListener('keydown', e => {\n        if (!e.ctrlKey) return;\n\n        switch (e.code) {\n        case 'KeyZ': editor.trigger('undo'); break;\n        case 'KeyY': editor.trigger('redo'); break;\n        default:\n        }\n    });\n\n    trackNodes(editor, history);\n    trackConnections(editor, history);\n}\n\nexport const Action = Act;\n\nexport default {\n    name: 'history',\n    install\n}\n"],"names":["Action","findNewConnection","oldConnection","input","output","connections","find","c","ConnectionActionHelper","editor","connection","connect","removeConnection","AddConnectionAction","helper","remove","add","RemoveConnectionAction","NodeAction","node","AddNodeAction","removeNode","addNode","RemoveNodeAction","DragNodeAction","prev","position","view","nodes","get","translate","_translate","History","active","produced","reserved","action","push","length","from","to","type","pop","_do","trackNodes","history","on","last","update","trackConnections","install","keyboard","bind","undo","redo","clear","document","addEventListener","e","ctrlKey","code","trigger","Act","name"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAAqBA;;;;;;;WACjB,gBAAO;;;WAEP,gBAAO;;;;;;ACAX,SAASC,iBAAT,CAA2BC,aAA3B,EAA0C;MAC9BC,KAAR,GAA0BD,aAA1B,CAAQC,KAAR;MAAeC,MAAf,GAA0BF,aAA1B,CAAeE,MAAf;SAEOA,MAAM,CAACC,WAAP,CAAmBC,IAAnB,CAAwB,UAAAC,CAAC;WAAIA,CAAC,CAACJ,KAAF,KAAYA,KAAhB;GAAzB,CAAP;;;IAGEK;kCACUC,MAAZ,EAAoBC,UAApB,EAAgC;;;SACvBD,MAAL,GAAcA,MAAd;SACKC,UAAL,GAAkBA,UAAlB;;;;;WAGJ,eAAM;WACGD,MAAL,CAAYE,OAAZ,CAAoB,KAAKD,UAAL,CAAgBN,MAApC,EAA4C,KAAKM,UAAL,CAAgBP,KAA5D;;;;WAGJ,kBAAS;WACAM,MAAL,CAAYG,gBAAZ,CAA6BX,iBAAiB,CAAC,KAAKS,UAAN,CAA9C;;;;;;;AAIR,IAAaG,mBAAb;;;;;+BACgBJ,MAAZ,EAAoBC,UAApB,EAAgC;;;;;;UAEvBI,MAAL,GAAc,IAAIN,sBAAJ,CAA2BC,MAA3B,EAAmCC,UAAnC,CAAd;;;;;;WAGJ,gBAAO;WAAOI,MAAL,CAAYC,MAAZ;;;;WAET,gBAAO;WAAOD,MAAL,CAAYE,GAAZ;;;;;EAR4BhB,MAAzC;AAWA,IAAaiB,sBAAb;;;;;kCACgBR,MAAZ,EAAoBC,UAApB,EAAgC;;;;;;WAEvBI,MAAL,GAAc,IAAIN,sBAAJ,CAA2BC,MAA3B,EAAmCC,UAAnC,CAAd;;;;;;WAGJ,gBAAO;WAAOI,MAAL,CAAYE,GAAZ;;;;WAET,gBAAO;WAAOF,MAAL,CAAYC,MAAZ;;;;;EAR+Bf,MAA5C;;ICjCMkB;;;;;sBACUT,MAAZ,EAAoBU,IAApB,EAA0B;;;;;;UAEjBV,MAAL,GAAcA,MAAd;UACKU,IAAL,GAAYA,IAAZ;;;;;EAJiBnB;;AAQzB,IAAaoB,aAAb;;;;;;;;;;;;;WACI,gBAAO;WACEX,MAAL,CAAYY,UAAZ,CAAuB,KAAKF,IAA5B;;;;WAGJ,gBAAO;WACEV,MAAL,CAAYa,OAAZ,CAAoB,KAAKH,IAAzB;;;;;EAN2BD,UAAnC;AAUA,IAAaK,gBAAb;;;;;;;;;;;;;WACI,gBAAO;WACEd,MAAL,CAAYa,OAAZ,CAAoB,KAAKH,IAAzB;;;;WAGJ,gBAAO;WACEV,MAAL,CAAYY,UAAZ,CAAuB,KAAKF,IAA5B;;;;;EAN8BD,UAAtC;AAUA,IAAaM,cAAb;;;;;0BACgBf,MAAZ,EAAoBU,IAApB,EAA0BM,IAA1B,EAAgC;;;;;gCACtBhB,MAAN,EAAcU,IAAd;WAEKM,IAAL,sBAAgBA,IAAhB;uCACeN,IAAI,CAACO,QAApB;;;;;;WAGJ,oBAAWA,QAAX,EAAqB;;;oCACZjB,MAAL,CAAYkB,IAAZ,CAAiBC,KAAjB,CAAuBC,GAAvB,CAA2B,KAAKV,IAAhC,GAAsCW,SAAtC,iDAAmDJ,QAAnD;;;;WAGJ,gBAAO;WACEK,UAAL,CAAgB,KAAKN,IAArB;;;;WAGJ,gBAAO;WACEM,UAAL,CAAgB,WAAhB;;;;WAGJ,gBAAOZ,IAAP,EAAa;uCACMA,IAAI,CAACO,QAApB;;;;;EArB4BR,UAApC;;IC9BqBc;qBACH;;;SACLC,MAAL,GAAc,KAAd;SACKC,QAAL,GAAgB,EAAhB;SACKC,QAAL,GAAgB,EAAhB;;;;;WAGJ,aAAIC,MAAJ,EAAY;UACJ,KAAKH,MAAT,EAAiB;WACZC,QAAL,CAAcG,IAAd,CAAmBD,MAAnB;WACKD,QAAL,GAAgB,EAAhB;;;;SAGJ,eAAW;aACA,KAAKD,QAAL,CAAc,KAAKA,QAAL,CAAcI,MAAd,GAAuB,CAArC,CAAP;;;;WAGJ,aAAIC,IAAJ,EAAUC,EAAV,EAAcC,IAAd,EAAoB;UACVL,MAAM,GAAGG,IAAI,CAACG,GAAL,EAAf;UAEI,CAACN,MAAL,EAAa;WAERH,MAAL,GAAc,IAAd;MACAG,MAAM,CAACK,IAAD,CAAN;MACAD,EAAE,CAACH,IAAH,CAAQD,MAAR;WACKH,MAAL,GAAc,KAAd;;;;WAGJ,gBAAO;WACEU,GAAL,CAAS,KAAKT,QAAd,EAAwB,KAAKC,QAA7B,EAAuC,MAAvC;;;;WAGJ,iBAAQ;WACCF,MAAL,GAAc,KAAd;WACKC,QAAL,GAAgB,EAAhB;WACKC,QAAL,GAAgB,EAAhB;;;;WAGJ,gBAAO;WACEQ,GAAL,CAAS,KAAKR,QAAd,EAAwB,KAAKD,QAA7B,EAAuC,MAAvC;;;;;;;AClCR,SAASU,UAAT,CAAoBnC,MAApB,EAA4BoC,OAA5B,EAAqC;EACjCpC,MAAM,CAACqC,EAAP,CAAU,aAAV,EAAyB,UAAA3B,IAAI;WAAI0B,OAAO,CAAC7B,GAAR,CAAY,IAAII,aAAJ,CAAkBX,MAAlB,EAA0BU,IAA1B,CAAZ,CAAJ;GAA7B;EACAV,MAAM,CAACqC,EAAP,CAAU,aAAV,EAAyB,UAAA3B,IAAI;WAAI0B,OAAO,CAAC7B,GAAR,CAAY,IAAIO,gBAAJ,CAAqBd,MAArB,EAA6BU,IAA7B,CAAZ,CAAJ;GAA7B;EACAV,MAAM,CAACqC,EAAP,CAAU,gBAAV,EAA4B,gBAAoB;QAAjB3B,IAAiB,QAAjBA,IAAiB;QAAXM,IAAW,QAAXA,IAAW;QACxCoB,OAAO,CAACE,IAAR,YAAwBvB,cAAxB,IAA0CqB,OAAO,CAACE,IAAR,CAAa5B,IAAb,KAAsBA,IAApE,EACI0B,OAAO,CAACE,IAAR,CAAaC,MAAb,CAAoB7B,IAApB,EADJ,KAGI0B,OAAO,CAAC7B,GAAR,CAAY,IAAIQ,cAAJ,CAAmBf,MAAnB,EAA2BU,IAA3B,EAAiCM,IAAjC,CAAZ;GAJR;;;AAQJ,SAASwB,gBAAT,CAA0BxC,MAA1B,EAAkCoC,OAAlC,EAA2C;EACvCpC,MAAM,CAACqC,EAAP,CAAU,mBAAV,EAA+B,UAAAvC,CAAC;WAAIsC,OAAO,CAAC7B,GAAR,CAAY,IAAIH,mBAAJ,CAAwBJ,MAAxB,EAAgCF,CAAhC,CAAZ,CAAJ;GAAhC;EACAE,MAAM,CAACqC,EAAP,CAAU,mBAAV,EAA+B,UAAAvC,CAAC;WAAIsC,OAAO,CAAC7B,GAAR,CAAY,IAAIC,sBAAJ,CAA2BR,MAA3B,EAAmCF,CAAnC,CAAZ,CAAJ;GAAhC;;;;AAIJ,SAAS2C,OAAT,CAAiBzC,MAAjB,SAA8C;6BAAnB0C,QAAmB;MAAnBA,QAAmB,+BAAR,IAAQ;EAC1C1C,MAAM,CAAC2C,IAAP,CAAY,MAAZ;EACA3C,MAAM,CAAC2C,IAAP,CAAY,MAAZ;EACA3C,MAAM,CAAC2C,IAAP,CAAY,YAAZ;MAEMP,OAAO,GAAG,IAAIb,OAAJ,EAAhB;EAEAvB,MAAM,CAACqC,EAAP,CAAU,MAAV,EAAkB;WAAMD,OAAO,CAACQ,IAAR,EAAN;GAAlB;EACA5C,MAAM,CAACqC,EAAP,CAAU,MAAV,EAAkB;WAAMD,OAAO,CAACS,IAAR,EAAN;GAAlB;EACA7C,MAAM,CAACqC,EAAP,CAAU,YAAV,EAAwB,UAAAV,MAAM;WAAIS,OAAO,CAAC7B,GAAR,CAAYoB,MAAZ,CAAJ;GAA9B;EACA3B,MAAM,CAACqC,EAAP,CAAU,OAAV,EAAmB,YAAM;IACrBD,OAAO,CAACU,KAAR;GADJ;MAGIJ,QAAJ,EAAcK,QAAQ,CAACC,gBAAT,CAA0B,SAA1B,EAAqC,UAAAC,CAAC,EAAI;QAChD,CAACA,CAAC,CAACC,OAAP,EAAgB;;YAERD,CAAC,CAACE,IAAV;WACK,MAAL;QAAanD,MAAM,CAACoD,OAAP,CAAe,MAAf;;;WACR,MAAL;QAAapD,MAAM,CAACoD,OAAP,CAAe,MAAf;;;;;GALH;EAUdjB,UAAU,CAACnC,MAAD,EAASoC,OAAT,CAAV;EACAI,gBAAgB,CAACxC,MAAD,EAASoC,OAAT,CAAhB;;;AAGJ,IAAa7C,QAAM,GAAG8D;AAEtB,YAAe;EACXC,IAAI,EAAE,SADK;EAEXb,OAAO,EAAPA;CAFJ;;;;;"}